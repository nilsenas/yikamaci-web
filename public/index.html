<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetonlu YÄ±kama Bulucu</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 10px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; margin: 10px 0; }
        
        /* HARÄ°TA KUTUSU */
        #map { 
            height: 350px; 
            width: 100%; 
            border-radius: 12px; 
            border: 2px solid #ddd;
            margin-bottom: 15px;
            z-index: 1;
        }

        .search-box { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        button { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-blue { background-color: #007bff; }
        .btn-gray { background-color: #6c757d; }
        .btn-green { background-color: #28a745; width: 100%; margin-bottom: 15px; padding: 12px; font-size: 16px; }
        .btn-red { background-color: #dc3545; padding: 6px 12px; font-size: 13px; margin-left: auto; }

        .card { 
            background: white; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .card-info h3 { margin: 0 0 5px 0; color: #007bff; font-size: 16px; }
        .card-info p { margin: 0; color: #666; font-size: 14px; }
        
        .btn-route { 
            text-decoration: none; 
            background-color: #ffc107; 
            color: #333; 
            padding: 6px 10px; 
            border-radius: 5px; 
            font-size: 13px; 
            font-weight: bold;
            margin-right: 5px;
        }
        .loading { text-align: center; color: #666; padding: 20px; }
    </style>
</head>
<body>

    <h1>ğŸš— YÄ±kama Bulucu</h1>

    <div id="map"></div>

    <button onclick="konumEkle()" class="btn-green">ğŸ“ Mevcut Konumu Ekle</button>

    <div class="search-box">
        <input type="text" id="ilInput" placeholder="Ä°l ara (Ã–rn: Ankara)">
        <button onclick="filtrele()" class="btn-blue">Ara</button>
        <button onclick="temizle()" class="btn-gray">TÃ¼mÃ¼</button>
    </div>

    <div id="liste"></div>

    <script>
        // --- YÃ–NETÄ°CÄ° ÅÄ°FRESÄ° ---
        const YONETICI_SIFRESI = "370634";

        // 1. HaritayÄ± BaÅŸlat (TÃ¼rkiye Merkezli - BOÅ)
        var map = L.map('map').setView([39.0, 35.0], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var markers = [];
        const listeDiv = document.getElementById('liste');
        const ilInput = document.getElementById('ilInput');

        // DÄ°KKAT: Sayfa aÃ§Ä±lÄ±nca verileriGetir() Ã§aÄŸÄ±rmÄ±yoruz!
        // Onun yerine kullanÄ±cÄ±ya mesaj veriyoruz.
        listeDiv.innerHTML = '<div class="loading">ğŸ” Haritada gÃ¶rmek iÃ§in bir il yazÄ±p <b>"Ara"</b> butonuna basÄ±n.<br>veya "TÃ¼mÃ¼" diyerek hepsini listeleyin.</div>';

        function verileriGetir(arananIl = '') {
            listeDiv.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
            
            // Haritadaki eski pinleri temizle
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            let url = '/api/istasyonlar';
            if (arananIl) url += '?il=' + arananIl;

            fetch(url)
                .then(res => res.json())
                .then(veriler => {
                    listeDiv.innerHTML = '';

                    if (!veriler.data || veriler.data.length === 0) {
                        listeDiv.innerHTML = '<div style="text-align:center; padding:20px;">Bu kriterde kayÄ±t bulunamadÄ±.</div>';
                        return;
                    }

                    veriler.data.forEach(istasyon => {
                        // A. Haritaya Pin Ekle
                        if (istasyon.lat && istasyon.lon) {
                            var marker = L.marker([istasyon.lat, istasyon.lon])
                                .addTo(map)
                                .bindPopup(`<b>${istasyon.ad}</b><br>${istasyon.il}`);
                            markers.push(marker);
                        }

                        // B. Listeye Kart Ekle
                        const rotaLink = `https://www.google.com/maps/search/?api=1&query=${istasyon.lat},${istasyon.lon}`;
                        const kart = `
                            <div class="card">
                                <div class="card-info">
                                    <h3>${istasyon.ad}</h3>
                                    <p>${istasyon.ilce || ''} / ${istasyon.il || 'Bilinmiyor'}</p>
                                </div>
                                <div style="display:flex; align-items:center;">
                                    <a href="${rotaLink}" target="_blank" class="btn-route">Git â†—</a>
                                    <button onclick="sil(${istasyon.id})" class="btn-red">Sil</button>
                                </div>
                            </div>`;
                        listeDiv.innerHTML += kart;
                    });

                    // C. HaritayÄ± Pinlere Odakla
                    if (markers.length > 0) {
                        var group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                });
        }

        async function konumEkle() {
            if (!confirm("Åu anki konumunuz kaydedilsin mi?")) return;
            if (!navigator.geolocation) return alert("Konum Ã¶zelliÄŸi kapalÄ±.");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                
                // Haritada gÃ¶ster
                map.setView([lat, lon], 15);
                // GeÃ§ici iÅŸaretÃ§i (veritabanÄ±ndan gelene kadar)
                L.marker([lat, lon]).addTo(map).bindPopup("Yeni Konum").openPopup();

                const ad = prompt("Ä°stasyon AdÄ±:", "Yeni YÄ±kama");
                if (!ad) return;

                // Adresi Bul
                let il = "Bilinmiyor", ilce = "";
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    il = data.address.province || data.address.city || "Bilinmiyor";
                    ilce = data.address.town || data.address.district || "";
                } catch (e) { console.log("Adres bulunamadÄ±"); }

                // Kaydet
                fetch('/api/ekle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ad, lat, lon, il, ilce })
                }).then(() => {
                    alert("Eklendi!");
                    // Ekleyince listeyi yenile ki kullanÄ±cÄ± gÃ¶rsÃ¼n
                    verileriGetir(); 
                });
            });
        }

        // --- ÅÄ°FRE KORUMALI SÄ°LME ---
        function sil(id) {
            const sifre = prompt("Silmek iÃ§in yÃ¶netici ÅŸifresini girin:");
            
            if (sifre === YONETICI_SIFRESI) {
                fetch('/api/sil/' + id, { method: 'DELETE' }).then(() => {
                    alert("KayÄ±t baÅŸarÄ±yla silindi.");
                    // Silince listeyi yenile
                    verileriGetir(ilInput.value.trim()); 
                });
            } else if (sifre !== null) {
                alert("HatalÄ± ÅŸifre! Ä°ÅŸlem iptal edildi.");
            }
        }

        function filtrele() { 
            const deger = ilInput.value.trim();
            if(!deger) {
                alert("LÃ¼tfen bir il ismi giriniz.");
                return;
            }
            verileriGetir(deger); 
        }

        function temizle() { 
            ilInput.value = ''; 
            verileriGetir(); 
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>