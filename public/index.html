<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jetonlu AraÃ§ YÄ±kama</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
<link rel="manifest" href="manifest.json">
/* --- TASARIM --- */
body{font-family:"Segoe UI",Arial,sans-serif;margin:0;background:#eef2f5}
header{background:#0078d7;color:#fff;text-align:center;padding:15px}
main{max-width:800px;margin:20px auto;padding:0 15px}
#map{height:400px;border-radius:8px;margin-bottom:15px; border:2px solid #ddd;}
section{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:20px}

/* Form ElemanlarÄ± */
input,button{padding:12px;margin:5px 0;border-radius:6px;border:1px solid #ccc; width: 100%; box-sizing: border-box; font-size:14px;}
button{background:#0078d7;color:#fff;border:none;cursor:pointer; font-weight: bold; transition:0.3s;}
button:hover{background:#005fa3}
button:disabled { background: #ccc; cursor: not-allowed; }
button.red{background:#d9534f; width: auto; padding: 5px 15px; font-size: 12px;}

/* Liste */
.list-group{list-style:none;padding:0; max-height: 300px; overflow-y: auto;}
.list-group li{background:#f9f9f9;margin:5px 0;padding:15px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items: center;}

/* Gizli Elemanlar */
.hidden{display:none;}

/* Adres Bilgi Kutusu */
#adresBilgisi {
    padding: 10px;
    background: #e8f0fe;
    border: 1px solid #b6d4fe;
    border-radius: 5px;
    color: #004085;
    margin-top: 5px;
    display: none; /* BaÅŸlangÄ±Ã§ta gizli */
    font-size: 13px;
}
</style>
</head>

<body>
<header>
  <h2>ğŸ’¦ Jetonlu YÄ±kama HaritasÄ±</h2>
</header>

<main>

<div id="map"></div>

<section>
  <h3>ğŸ” Konum Ara</h3>
  <div style="display:flex; gap:5px;">
    <input id="aramaIl" placeholder="Ä°l (Ã¶r: Ankara)">
    <input id="aramaIlce" placeholder="Ä°lÃ§e (Ä°steÄŸe baÄŸlÄ±)">
  </div>
  <button id="araBtn">Ara</button>
  <button id="tumunuGosterBtn" style="background:#555;">TÃ¼mÃ¼nÃ¼ GÃ¶ster</button>
</section>

<section>
  <h3>â• Yeni Ä°stasyon Ekle</h3>
  
  <input id="ad" placeholder="Ä°stasyon AdÄ± (Ã–r: Ã–zen YÄ±kama)" required>
  
  <button id="konumBulBtn" style="background:#28a745;">ğŸ“ Konumumu Bul ve Adresi Getir</button>
  
  <div id="adresBilgisi"></div>

  <button id="kaydetBtn" disabled style="margin-top:10px;">ğŸ’¾ Kaydet</button>

  <input type="hidden" id="il">
  <input type="hidden" id="ilce">
  <input type="hidden" id="lat">
  <input type="hidden" id="lon">
</section>

<section>
  <h3>ğŸ“‹ SonuÃ§lar</h3>
  <ul id="istasyonList" class="list-group">
      <li style="text-align:center; color:#777;">Listeyi gÃ¶rmek iÃ§in arama yapÄ±n.</li>
  </ul>
  
  <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
      <small style="color:#999;">âš ï¸ YÃ¶netici Silme Ä°ÅŸlemi</small>
      <input type="password" id="silmeSifre" placeholder="YÃ¶netici Åifresi">
  </div>
</section>

</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- AYARLAR ---
const API_URL = "/api/istasyonlar"; 
let tumIstasyonlar = []; 

// --- HARÄ°TA ---
const map = L.map("map").setView([39.92, 32.85], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let markers = L.layerGroup().addTo(map);

// --- TÃœRKÃ‡E KARAKTER DÃœZELTME ---
function trKucult(metin) {
    if(!metin) return "";
    return metin.toString()
        .replace(/Ä°/g, "i").replace(/I/g, "Ä±")
        .replace(/Ä/g, "ÄŸ").replace(/Ãœ/g, "Ã¼")
        .replace(/Å/g, "ÅŸ").replace(/Ã–/g, "Ã¶")
        .replace(/Ã‡/g, "Ã§")
        .toLowerCase().trim();
}

// --- 1. OTOMATÄ°K ADRES BULMA (TERSÄ°NE KODLAMA) ---
const konumBtn = document.getElementById("konumBulBtn");
const adresKutusu = document.getElementById("adresBilgisi");
const kaydetBtn = document.getElementById("kaydetBtn");

konumBtn.onclick = () => {
    if(!navigator.geolocation) return alert("CihazÄ±nÄ±zda GPS yok.");
    
    konumBtn.innerText = "â³ Konum ve Adres AlÄ±nÄ±yor...";
    konumBtn.disabled = true; // Tekrar basÄ±lmasÄ±n

    navigator.geolocation.getCurrentPosition(
        async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            // KoordinatlarÄ± gizli kutulara yaz
            document.getElementById("lat").value = lat;
            document.getElementById("lon").value = lon;

            try {
                // OpenStreetMap Servisine Soruyoruz: Bu koordinat neresi?
                // (Nominatim API Ãœcretsizdir)
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
                const response = await fetch(url);
                const data = await response.json();

                // Adres parÃ§alarÄ±nÄ± al (API bazen 'province' bazen 'city' dÃ¶ndÃ¼rÃ¼r)
                const adres = data.address;
                const bulunanIl = adres.province || adres.state || adres.city || "Bilinmiyor";
                const bulunanIlce = adres.town || adres.district || adres.county || adres.suburb || "Merkez";

                // Gizli kutulara yaz
                document.getElementById("il").value = bulunanIl;
                document.getElementById("ilce").value = bulunanIlce;

                // KullanÄ±cÄ±ya gÃ¶ster
                adresKutusu.style.display = "block";
                adresKutusu.innerHTML = `âœ… <b>Adres Bulundu:</b> ${bulunanIl} / ${bulunanIlce}<br><small>(Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)})</small>`;
                
                // Kaydet butonunu aÃ§
                konumBtn.innerText = "ğŸ“ Konum GÃ¼ncellendi";
                konumBtn.style.background = "#17a2b8";
                konumBtn.disabled = false;
                kaydetBtn.disabled = false;

            } catch (error) {
                console.error(error);
                alert("Konum alÄ±ndÄ± ama adres ismi bulunamadÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
                // Adres bulunamazsa bile koordinat var, kaydetmeye izin verelim
                document.getElementById("il").value = "Konum";
                document.getElementById("ilce").value = "Bilinmiyor";
                kaydetBtn.disabled = false;
            }
        },
        (err) => {
            alert("Konum alÄ±namadÄ±. GPS aÃ§Ä±k mÄ±?");
            konumBtn.innerText = "ğŸ“ Konumumu Bul ve Adresi Getir";
            konumBtn.disabled = false;
        }
    );
};

// --- 2. KAYDETME ---
kaydetBtn.onclick = async () => {
    const ad = document.getElementById("ad").value;
    const il = document.getElementById("il").value;
    const ilce = document.getElementById("ilce").value;
    const lat = document.getElementById("lat").value;
    const lon = document.getElementById("lon").value;

    if(!ad) return alert("LÃ¼tfen Ä°stasyon AdÄ±nÄ± giriniz.");

    const yeniVeri = {
        ad: ad,
        il: il,
        ilce: ilce,
        lat: parseFloat(lat),
        lon: parseFloat(lon)
    };

    try {
        const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(yeniVeri)
        });

        if(res.ok) {
            alert("âœ… Ä°stasyon baÅŸarÄ±yla kaydedildi!");
            // Formu sÄ±fÄ±rla
            document.getElementById("ad").value = "";
            adresKutusu.style.display = "none";
            kaydetBtn.disabled = true;
            konumBtn.innerText = "ğŸ“ Konumumu Bul ve Adresi Getir";
            konumBtn.style.background = "#28a745";
            verileriHazirla(); // Listeyi gÃ¼ncelle
        } else {
            alert("KayÄ±t hatasÄ±.");
        }
    } catch (err) { alert("Sunucu hatasÄ±."); }
};

// --- 3. VERÄ°LERÄ° Ã‡EK ---
async function verileriHazirla() {
    try {
        const res = await fetch(API_URL);
        tumIstasyonlar = await res.json();
    } catch (err) { console.error(err); }
}

// --- 4. LÄ°STELEME ---
function listeyiGuncelle(veri) {
    markers.clearLayers();
    const liste = document.getElementById("istasyonList");
    liste.innerHTML = "";

    if(veri.length === 0) {
        liste.innerHTML = "<li style='text-align:center'>SonuÃ§ bulunamadÄ±.</li>";
        return;
    }

    veri.forEach(item => {
        L.marker([item.lat, item.lon]).addTo(markers)
         .bindPopup(`<b>${item.ad}</b><br>${item.il} / ${item.ilce}`);

        liste.innerHTML += `
            <li>
                <span onclick="haritayaGit(${item.lat}, ${item.lon})" style="cursor:pointer; color:#0078d7; font-weight:bold;">
                    ${item.ad} <small style="color:#666">(${item.il}/${item.ilce})</small>
                </span>
                <button class="red" onclick="sil(${item.id})">Sil</button>
            </li>
        `;
    });
    
    // Ä°lk sonuca odaklan
    if(veri.length > 0) map.setView([veri[0].lat, veri[0].lon], 9);
}

window.haritayaGit = (lat, lon) => {
    map.setView([lat, lon], 14);
};

// --- 5. ARAMA ---
document.getElementById("araBtn").onclick = () => {
    if(tumIstasyonlar.length === 0) verileriHazirla();
    
    const girilenIl = trKucult(document.getElementById("aramaIl").value);
    const girilenIlce = trKucult(document.getElementById("aramaIlce").value);

    if (!girilenIl) return alert("LÃ¼tfen en az bir Ä°l yazÄ±n.");

    const sonuclar = tumIstasyonlar.filter(item => {
        const veriIl = trKucult(item.il);
        const veriIlce = trKucult(item.ilce);
        
        if (girilenIlce === "") return veriIl.includes(girilenIl);
        return veriIl.includes(girilenIl) && veriIlce.includes(girilenIlce);
    });

    listeyiGuncelle(sonuclar);
};

document.getElementById("tumunuGosterBtn").onclick = () => {
    verileriHazirla().then(() => {
         listeyiGuncelle(tumIstasyonlar);
         map.setView([39.92, 32.85], 6);
    });
};

// --- 6. SÄ°LME ---
async function sil(id) {
    const sifre = document.getElementById("silmeSifre").value;
    if(!sifre) return alert("YÃ¶netici ÅŸifresi gerekli.");
    if(!confirm("Emin misin?")) return;

    try {
        const res = await fetch(API_URL + "/" + id, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sifre: sifre })
        });
        if(res.ok) {
            alert("Silindi.");
            verileriHazirla().then(() => {
                document.getElementById("istasyonList").innerHTML = "";
                markers.clearLayers();
            });
        } else {
            alert("Åifre YanlÄ±ÅŸ!");
        }
    } catch (err) { alert("Hata."); }
}

verileriHazirla();
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('Uygulama yÃ¼kleyicisi hazÄ±r'));
  }
</script>
</body>
</html>