<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetonlu Yƒ±kama Bulucu</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        
        /* Arama ve Butonlar */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 15px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: bold; }
        
        .btn-blue { background-color: #007bff; color: white; }
        .btn-gray { background-color: #6c757d; color: white; }
        .btn-green { background-color: #28a745; color: white; width: 100%; margin-bottom: 20px; font-size: 16px; }
        .btn-red { background-color: #dc3545; color: white; margin-left: 10px; }
        
        /* Kart Tasarƒ±mƒ± */
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; color: #007bff; }
        
        .map-btn { text-decoration: none; background-color: #17a2b8; color: white; padding: 8px 15px; border-radius: 5px; font-size: 14px; }
        .loading { text-align: center; color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>üöó Yƒ±kama Bulucu</h1>

    <button onclick="konumEkle()" class="btn-green">üìç Mevcut Konumu Ekle</button>

    <div class="search-box">
        <input type="text" id="ilInput" placeholder="Hangi il?">
        <button onclick="filtrele()" class="btn-blue">Ara</button>
        <button onclick="temizle()" class="btn-gray">T√ºm√º</button>
    </div>

    <div id="liste"></div>

    <script>
        const listeDiv = document.getElementById('liste');
        const ilInput = document.getElementById('ilInput');

        verileriGetir();

        // --- Verileri √áek ve Listele ---
        function verileriGetir(arananIl = '') {
            listeDiv.innerHTML = '<div class="loading">Y√ºkleniyor...</div>';
            
            let url = '/api/istasyonlar';
            if (arananIl) url += '?il=' + arananIl;

            fetch(url)
                .then(res => res.json())
                .then(veriler => {
                    listeDiv.innerHTML = '';
                    
                    if (!veriler.data || veriler.data.length === 0) {
                        listeDiv.innerHTML = '<div class="card">Kayƒ±t bulunamadƒ±.</div>';
                        return;
                    }

                    veriler.data.forEach(istasyon => {
                        // Google Maps Linki
                        const haritaLink = `https://www.google.com/maps/search/?api=1&query=${istasyon.lat},${istasyon.lon}`;
                        
                        const kart = `
                            <div class="card">
                                <h3>${istasyon.ad}</h3>
                                <p>üìç ${istasyon.ilce || ''} / ${istasyon.il || 'Konum'}</p>
                                <div style="margin-top:10px;">
                                    <a href="${haritaLink}" target="_blank" class="map-btn">Harita üó∫Ô∏è</a>
                                    <button onclick="sil(${istasyon.id})" class="btn-red">Sil üóëÔ∏è</button>
                                </div>
                            </div>`;
                        listeDiv.innerHTML += kart;
                    });
                });
        }

        // --- Yeni Konum Ekleme ---
        async function konumEkle() {
            if (!confirm("Konum kaydedilsin mi?")) return;
            if (!navigator.geolocation) return alert("Konum servisi yok.");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const ad = prompt("ƒ∞stasyon Adƒ±:", "Yeni Yƒ±kama");
                
                if (!ad) return;

                // Basit ≈ûehir Bulma (Hata verirse 'Bilinmiyor' yazar, sistemi bozmaz)
                let il = "Bilinmiyor", ilce = "";
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    il = data.address.province || data.address.city || "Bilinmiyor";
                    ilce = data.address.town || data.address.district || "";
                } catch (e) { console.log("Adres bulunamadƒ±"); }

                // Kaydet
                fetch('/api/ekle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ad, lat, lon, il, ilce })
                }).then(() => {
                    alert("Eklendi!");
                    verileriGetir();
                });
            });
        }

        // --- Silme ---
        function sil(id) {
            if(!confirm("Silinsin mi?")) return;
            fetch('/api/sil/' + id, { method: 'DELETE' }).then(() => verileriGetir());
        }

        function filtrele() { verileriGetir(ilInput.value.trim()); }
        function temizle() { ilInput.value = ''; verileriGetir(); }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>