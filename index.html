<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetonlu Yƒ±kama Bulucu</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 10px; background-color: #f4f4f9; }
        
        /* Harita Kutusu */
        #map { 
            height: 350px; 
            width: 100%; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            border: 2px solid #ddd;
            z-index: 1; /* Men√ºlerin altƒ±nda kalmamasƒ± i√ßin */
        }

        h1 { text-align: center; color: #333; font-size: 22px; margin: 10px 0; }
        
        .search-box { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        
        button { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-blue { background-color: #007bff; }
        .btn-gray { background-color: #6c757d; }
        .btn-green { background-color: #28a745; width: 100%; margin-bottom: 10px; font-size: 16px; padding: 12px; }
        .btn-red { background-color: #dc3545; padding: 5px 10px; font-size: 12px; margin-left: auto; }

        .card { 
            background: white; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .card-info h3 { margin: 0 0 5px 0; color: #007bff; font-size: 16px; }
        .card-info p { margin: 0; color: #666; font-size: 14px; }
        
        .btn-route { 
            text-decoration: none; 
            background-color: #ffc107; 
            color: #333; 
            padding: 6px 10px; 
            border-radius: 5px; 
            font-size: 13px; 
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <h1>üöó Yƒ±kama Bulucu</h1>

    <div id="map"></div>

    <button onclick="konumEkle()" class="btn-green">üìç Buradayƒ±m! (Ekle)</button>

    <div class="search-box">
        <input type="text" id="ilInput" placeholder="ƒ∞l ara...">
        <button onclick="filtrele()" class="btn-blue">Ara</button>
        <button onclick="temizle()" class="btn-gray">T√ºm√º</button>
    </div>

    <div id="liste"></div>

    <script>
        // Haritayƒ± Ba≈ülat (T√ºrkiye Merkezli)
        var map = L.map('map').setView([39.9334, 32.8597], 6);
        
        // Harita Katmanƒ±nƒ± Ekle (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        var markers = []; // Pinleri tutacaƒüƒ±mƒ±z liste

        const listeDiv = document.getElementById('liste');
        const ilInput = document.getElementById('ilInput');

        verileriGetir();

        function verileriGetir(arananIl = '') {
            listeDiv.innerHTML = '<div style="text-align:center">Y√ºkleniyor...</div>';
            
            // Haritadaki eski pinleri temizle
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            let url = '/api/istasyonlar';
            if (arananIl) url += '?il=' + arananIl;

            fetch(url)
                .then(res => res.json())
                .then(veriler => {
                    listeDiv.innerHTML = '';

                    if (!veriler.data || veriler.data.length === 0) {
                        listeDiv.innerHTML = '<div style="text-align:center">Kayƒ±t bulunamadƒ±.</div>';
                        return;
                    }

                    veriler.data.forEach(istasyon => {
                        // 1. Haritaya Pƒ∞N Ekle
                        if (istasyon.lat && istasyon.lon) {
                            var marker = L.marker([istasyon.lat, istasyon.lon])
                                .addTo(map)
                                .bindPopup(`<b>${istasyon.ad}</b><br>${istasyon.il}`);
                            markers.push(marker);
                        }

                        // 2. Listeye KART Ekle
                        // Google Haritalar'da Rota √áizmek i√ßin link
                        const rotaLink = `https://www.google.com/maps/dir/?api=1&destination=${istasyon.lat},${istasyon.lon}`;
                        
                        const kart = `
                            <div class="card">
                                <div class="card-info">
                                    <h3>${istasyon.ad}</h3>
                                    <p>${istasyon.ilce || ''} / ${istasyon.il}</p>
                                </div>
                                <div style="display:flex; align-items:center;">
                                    <a href="${rotaLink}" target="_blank" class="btn-route">Yol Tarifi ‚Üó</a>
                                    <button onclick="sil(${istasyon.id})" class="btn-red">Sil</button>
                                </div>
                            </div>`;
                        listeDiv.innerHTML += kart;
                    });

                    // Eƒüer veri varsa haritayƒ± o b√∂lgeye odakla (Fit Bounds)
                    if (markers.length > 0) {
                        var group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                });
        }

        async function konumEkle() {
            if (!confirm("≈ûu anki konumunuz haritaya eklensin mi?")) return;
            
            if (!navigator.geolocation) return alert("Cihazƒ±nƒ±z konum √∂zelliƒüini desteklemiyor.");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                // Haritayƒ± oraya odakla
                map.setView([lat, lon], 15);
                L.marker([lat, lon]).addTo(map).bindPopup("Sizin Konumunuz").openPopup();

                const ad = prompt("Burasƒ± neresi? (ƒ∞stasyon Adƒ±):", "Yeni Yƒ±kama");
                if (!ad) return;

                // Adresi Bul (Otomatik)
                let il = "Bilinmiyor", ilce = "";
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    il = data.address.province || data.address.city || "Bilinmiyor";
                    ilce = data.address.town || data.address.district || "";
                } catch (e) { console.log("Adres bulunamadƒ±"); }

                // Kaydet
                fetch('/api/ekle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ad, lat, lon, il, ilce })
                }).then(() => {
                    alert("Haritaya eklendi! üéâ");
                    verileriGetir(); // Listeyi ve haritayƒ± yenile
                });
            }, (error) => {
                alert("Konum alƒ±namadƒ±: " + error.message);
            });
        }

        function sil(id) {
            if(!confirm("Silinsin mi?")) return;
            fetch('/api/sil/' + id, { method: 'DELETE' }).then(() => verileriGetir());
        }

        function filtrele() { verileriGetir(ilInput.value.trim()); }
        function temizle() { ilInput.value = ''; verileriGetir(); }
        
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>