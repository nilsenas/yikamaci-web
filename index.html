<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetonlu Yƒ±kama Bulucu</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 10px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; margin: 10px 0; }
        
        /* HARƒ∞TA */
        #map { height: 350px; width: 100%; border-radius: 12px; border: 2px solid #ddd; margin-bottom: 15px; z-index: 1; }

        /* BUTON GRUBU */
        .action-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-green { background-color: #28a745; flex: 1; padding: 12px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-orange { background-color: #fd7e14; flex: 1; padding: 12px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ARAMA KUTUSU */
        .search-box { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn-blue { background-color: #007bff; padding: 10px 15px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-gray { background-color: #6c757d; padding: 10px 15px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ADRES EKLEME FORMU (Gizli) */
        #adresFormu { display: none; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #ddd; }
        #adresFormu input { width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        .form-title { font-weight: bold; margin-bottom: 10px; display: block; color: #333; }

        /* KART TASARIMI */
        .card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .card-info h3 { margin: 0 0 5px 0; color: #007bff; font-size: 16px; }
        .card-info p { margin: 0; color: #666; font-size: 14px; }
        .btn-route { text-decoration: none; background-color: #ffc107; color: #333; padding: 6px 10px; border-radius: 5px; font-size: 13px; font-weight: bold; margin-right: 5px; }
        .btn-red { background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
        
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>

    <h1>üöó Yƒ±kama Bulucu</h1>

    <div id="map"></div>

    <div class="action-buttons">
        <button onclick="konumEkle()" class="btn-green">üìç Konumumu Ekle</button>
        <button onclick="formuGoster()" class="btn-orange">üè† Adres ile Ekle</button>
    </div>

    <div id="adresFormu">
        <span class="form-title">Yeni Yer Ekle</span>
        <input type="text" id="yeniAd" placeholder="ƒ∞stasyon Adƒ± (√ñrn: Yƒ±ldƒ±z Yƒ±kama)">
        <input type="text" id="yeniIl" placeholder="ƒ∞l (√ñrn: ƒ∞stanbul)">
        <input type="text" id="yeniIlce" placeholder="ƒ∞l√ße (√ñrn: Be≈üikta≈ü)">
        <input type="text" id="yeniMahalle" placeholder="Mahalle (√ñrn: Konaklar Mah.)">
        <button onclick="adrestenKoordinatBul()" class="btn-green" style="width:100%">Kaydet</button>
        <button onclick="formuGizle()" class="btn-red" style="width:100%; margin-top:5px; background:#666;">ƒ∞ptal</button>
    </div>

    <div class="search-box">
        <input type="text" id="ilInput" placeholder="ƒ∞l ara (√ñrn: Ankara)">
        <button onclick="filtrele()" class="btn-blue">Ara</button>
        <button onclick="temizle()" class="btn-gray">Temizle</button>
    </div>

    <div id="liste"></div>

    <script>
        const YONETICI_SIFRESI = "370634";
        const listeDiv = document.getElementById('liste');
        const ilInput = document.getElementById('ilInput');
        var markers = [];

        // 1. HARƒ∞TA AYARLARI (Ba≈ülangƒ±√ßta Sadece T√ºrkiye)
        var map = L.map('map').setView([39.0, 35.0], 6); // T√ºrkiye Ortasƒ±, Uzak Bakƒ±≈ü
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        // A√áILI≈û MESAJI (Otomatik veri √ßekme YOK)
        listeDiv.innerHTML = '<div class="loading">üîç Harita bo≈ü ba≈ülatƒ±ldƒ±.<br>Konumlarƒ± g√∂rmek i√ßin bir ƒ∞l yazƒ±p <b>"Ara"</b> butonuna basƒ±n.</div>';

        // --- VERƒ∞ √áEKME VE Lƒ∞STELEME ---
        function verileriGetir(arananIl = '') {
            // Haritayƒ± temizle
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            listeDiv.innerHTML = '<div class="loading">Aranƒ±yor...</div>';

            let url = '/api/istasyonlar';
            if (arananIl) url += '?il=' + arananIl;

            fetch(url)
                .then(res => res.json())
                .then(veriler => {
                    listeDiv.innerHTML = '';

                    if (!veriler.data || veriler.data.length === 0) {
                        listeDiv.innerHTML = '<div class="loading">Bu b√∂lgede kayƒ±t bulunamadƒ±.</div>';
                        // Haritayƒ± tekrar T√ºrkiye geneline al
                        map.setView([39.0, 35.0], 6);
                        return;
                    }

                    veriler.data.forEach(istasyon => {
                        // GOOGLE MAPS Lƒ∞NKƒ∞
                        const navLink = `https://www.google.com/maps/search/?api=1&query=${istasyon.lat},${istasyon.lon}`;

                        // A. HARƒ∞TAYA Pƒ∞N EKLE (Yol Tarifi Linki ile)
                        if (istasyon.lat && istasyon.lon) {
                            var marker = L.marker([istasyon.lat, istasyon.lon])
                                .addTo(map)
                                .bindPopup(`
                                    <b>${istasyon.ad}</b><br>
                                    ${istasyon.il√ße || ''} / ${istasyon.il}<br>
                                    <a href="${navLink}" target="_blank" style="color:blue; font-weight:bold;">üöó Yol Tarifi Al</a>
                                `);
                            markers.push(marker);
                        }

                        // B. Lƒ∞STEYE KART EKLE
                        const kart = `
                            <div class="card">
                                <div class="card-info">
                                    <h3>${istasyon.ad}</h3>
                                    <p>${istasyon.ilce || ''} / ${istasyon.il}</p>
                                </div>
                                <div>
                                    <a href="${navLink}" target="_blank" class="btn-route">Git ‚Üó</a>
                                    <button onclick="sil(${istasyon.id})" class="btn-red">Sil</button>
                                </div>
                            </div>`;
                        listeDiv.innerHTML += kart;
                    });

                    // Haritayƒ± sonu√ßlara odakla
                    if (markers.length > 0) {
                        var group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                });
        }

        // --- 1. Y√ñNTEM: GPS ƒ∞LE KONUM EKLE ---
        async function konumEkle() {
            if (!confirm("Bulunduƒüunuz konum kaydedilsin mi?")) return;
            if (!navigator.geolocation) return alert("Konum a√ßƒ±lamadƒ±.");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const ad = prompt("ƒ∞stasyon Adƒ±:", "Yeni Yƒ±kama");
                if (!ad) return;

                // Adres Bul
                let il = "Bilinmiyor", ilce = "";
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    il = data.address.province || data.address.city || "Bilinmiyor";
                    ilce = data.address.town || data.address.district || "";
                } catch (e) {}

                kaydet(ad, lat, lon, il, ilce);
            });
        }

        // --- 2. Y√ñNTEM: ADRES Gƒ∞REREK EKLE ---
        function formuGoster() { document.getElementById('adresFormu').style.display = 'block'; }
        function formuGizle() { document.getElementById('adresFormu').style.display = 'none'; }

        async function adrestenKoordinatBul() {
            const ad = document.getElementById('yeniAd').value;
            const il = document.getElementById('yeniIl').value;
            const ilce = document.getElementById('yeniIlce').value;
            const mahalle = document.getElementById('yeniMahalle').value;

            if (!ad || !il || !ilce) return alert("L√ºtfen Ad, ƒ∞l ve ƒ∞l√ße giriniz.");

            // Adresi Koordinata √áevir (OpenStreetMap API)
            const adresSorgu = `${mahalle}, ${ilce}, ${il}, Turkey`;
            
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adresSorgu)}`);
                const data = await res.json();

                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    
                    if(confirm(`Konum Bulundu: ${data[0].display_name}\nKaydedilsin mi?`)) {
                        kaydet(ad, lat, lon, il, ilce);
                        formuGizle();
                        // Formu temizle
                        document.getElementById('yeniAd').value = '';
                        document.getElementById('yeniMahalle').value = '';
                    }
                } else {
                    alert("Adres bulunamadƒ±! L√ºtfen mahalle veya il√ße ismini kontrol edin.");
                }
            } catch (e) {
                alert("Baƒülantƒ± hatasƒ± olu≈ütu.");
            }
        }

        // --- ORTAK KAYDETME FONKSƒ∞YONU ---
        function kaydet(ad, lat, lon, il, ilce) {
            fetch('/api/ekle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ad, lat, lon, il, ilce })
            }).then(() => {
                alert("Kayƒ±t Ba≈üarƒ±lƒ±! ‚úÖ");
                // Eklenen yeri g√∂rmek i√ßin o ili ara
                ilInput.value = il; 
                verileriGetir(il); 
            });
        }

        // --- Sƒ∞LME ---
        function sil(id) {
            const sifre = prompt("Silmek i√ßin y√∂netici ≈üifresini girin:");
            if (sifre === YONETICI_SIFRESI) {
                fetch('/api/sil/' + id, { method: 'DELETE' }).then(() => {
                    alert("Silindi.");
                    verileriGetir(ilInput.value.trim());
                });
            } else if (sifre !== null) alert("Hatalƒ± ≈üifre!");
        }

        function filtrele() { 
            const deger = ilInput.value.trim();
            if(!deger) return alert("L√ºtfen bir il yazƒ±n.");
            verileriGetir(deger); 
        }
        
        function temizle() {
            ilInput.value = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            listeDiv.innerHTML = '<div class="loading">Harita temizlendi.</div>';
            map.setView([39.0, 35.0], 6);
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>